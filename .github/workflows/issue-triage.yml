name: Issue triage

on:
  issues:
    types: [opened, edited]

jobs:
  ensure-acceptance:
    name: Ensure acceptance checklist
    runs-on: ubuntu-latest
    steps:
      - name: Ensure acceptance checklist exists
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.issue.body || '';
            const hasChecklist = /- \[[ xX]\]/.test(body) || /Acceptance:/i.test(body);
            if (!hasChecklist) {
              const checklist = `\n\n**Acceptance criteria**:\n- [ ] Deliverable: Clear, testable implementation\n- [ ] Owner: @cbwinslow\n- [ ] ETA: TBD\n- [ ] Tests: Unit or smoke test added, CI uploads sample artifacts\n`;
              const newBody = body + checklist;
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: newBody
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'Automated: Added an **Acceptance criteria** checklist to make this issue actionable. Edit owner/ETA as needed.'
              });
            }
